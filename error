WITH ds AS
(
  SELECT
    header.InvoiceNo AS HeaderInvoiceNo,
    line.InvoiceNo AS LineInvoiceNo
  FROM
    dbo.earth_dp_ShipmentRequestInfoHeaderIF header FULL JOIN
    dbo.earth_dp_ShipmentRequestInfoLineIF line ON header.InvoiceNo = line.InvoiceNo
  WHERE
    header.DataLakeModified_DateTime > '@{variables('formattedLastExecutionTime')}' AND
    line.DataLakeModified_DateTime > '@{variables('formattedLastExecutionTime')}'
)
SELECT
  (SELECT COUNT(ALL LineInvoiceNo) FROM ds) AS LineCount,
  IIF(
    (SELECT COUNT(ALL LineInvoiceNo) FROM ds) > 0 AND
    (SELECT COUNT(*) FROM ds WHERE HeaderInvoiceNo IS NULL OR LineInvoiceNo IS NULL) = 0,
	  1,
	  0
  ) AS IsAvailable
