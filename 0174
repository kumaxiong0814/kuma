WITH DataSource AS (
  SELECT
    InterfaceId,
    ErrorClassification,
    CASE 
      WHEN ISNULL(OrderSource, '') = '' THEN NULL
      ELSE CONCAT(SUBSTRING(OrderSource, 1, 2), SUBSTRING(CONVERT(VARCHAR(10), IF0174Seq), 3, 8))
    END AS OhiId,
    Status,
    CASE 
      WHEN ISNULL(OrderSource, '') = '' THEN ''
      ELSE CONCAT(SUBSTRING(OrderSource, 1, 3), IF0174Seq)
    END AS OrigSysDocumentRef,
    CONVERT(INT, NULLIF(OrderSource, '')) AS OrderSource,
    CustomerPoNumber,
    CustomerNumber,
    ShipmentPriorityCode,
    ShipToOrgCode,
    OrganizationCode,
    SecondaryInventoryName,
    CASE 
      WHEN ISNULL(OrderSource, '') = '' THEN NULL
      ELSE CONCAT(SUBSTRING(OrderSource, 1, 2), SUBSTRING(CONVERT(VARCHAR(10), IF0174Seq), 3, 8))
    END AS OliId,
    OrigSysLineRef,
    InventoryItemSegment1,
    OrderedQuantity,
    InvoiceToOrgCode,
    ErrorMessage,
    SalesTableOIFRecId
  FROM earth_dp_SpoonsOrderIF_LS_IF_0174_TempWithSeq
),
GroupedOhiId AS (
  SELECT 
    *,
    ROW_NUMBER() OVER (PARTITION BY OrderSource, CustomerPoNumber ORDER BY OrigSysLineRef) AS RowNum
  FROM DataSource
)
SELECT
  CustomerNumber,
  CustomerPoNumber,
  ErrorClassification,
  ErrorMessage,
  InterfaceId,
  InventoryItemSegment1,
  InvoiceToOrgCode,
  COALESCE(LAG(OhiId) OVER (PARTITION BY OrderSource, CustomerPoNumber ORDER BY OrigSysLineRef), '') AS OhiId,
  CASE 
    WHEN RowNum = 1 THEN OhiId
    ELSE CONCAT(CONCAT(SUBSTRING(OrderSource, 1, 2), SUBSTRING(CONVERT(VARCHAR(10), IF0174Seq), 3, 8)), RIGHT('000' + CAST(ROW_NUMBER() OVER (PARTITION BY OrderSource, CustomerPoNumber ORDER BY OrigSysLineRef) AS VARCHAR(3)), 3))
  END AS OliId,
  OrderSource,
  OrderedQuantity,
  OrganizationCode,
  OrigSysDocumentRef,
  OrigSysLineRef,
  SecondaryInventoryName,
  ShipToOrgCode,
  ShipmentPriorityCode,
  SalesTableOIFRecId,
  Status
FROM GroupedOhiId
ORDER BY OrigSysLineRef;
